<? // Отчёт "Входящие и статистика определения за дату"

// *** подключение к серверу MySQL ***
$hostname="10.1.1.2";
$username="sel";
$password="";
$dbName="MyStat";
$MYSQLCON = MYSQL_CONNECT($hostname,$username,$password) OR DIE("Can't create connection");
MYSQL_SELECT_DB("$dbName") OR DIE("Can't select DataBase"); 

// *** формирование титула отчёта ***
$title="";
IF (($sday==$fday)&&($smonth==$fmonth)&&($syear==$fyear)) $dayrep=1;
IF ($dayrep==1)
{
 $title .=$sday;
 $title .=" ";
 IF ($smonth=="01") $title .="января ";
 IF ($smonth=="02") $title .="февраля ";
 IF ($smonth=="03") $title .="марта ";
 IF ($smonth=="04") $title .="апреля ";
 IF ($smonth=="05") $title .="мая ";
 IF ($smonth=="06") $title .="июня ";
 IF ($smonth=="07") $title .="июля ";
 IF ($smonth=="08") $title .="августа ";
 IF ($smonth=="09") $title .="сентября ";
 IF ($smonth=="10") $title .="октября ";
 IF ($smonth=="11") $title .="ноября ";
 IF ($smonth=="12") $title .="декабря ";
 $title .="$syear года";
}
ELSE
{
 $title .="период с $sday/$smonth/$syear по $fday/$fmonth/$fyear";
};

// *** формирование заголовка HTML-документа ***
PRINT "<!-- \nДля печати выставьте следующие параметры страницы:\nслева:30.00\nсверху, справа, снизу 5.00\nориентация книжная\nнижний колонтитул: &b&bСтраница &p из &P\n-->\n";
PRINT "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\">\n";
PRINT "<HTML>\n<HEAD>\n";
PRINT "<TITLE>Входящие и статистика определения по дням подробно за $title</TITLE>\n";
PRINT "<META content=\"text/html; charset=Windows-1251\" http-equiv=Content-Type>\n";
PRINT "<STYLE>@import url(ie5.css);</STYLE>\n";
PRINT "<LINK DISABLED REL=\"stylesheet\" HREF=\"ie5.css\">\n";
PRINT "</HEAD>\n<BODY>\n";

 // *****************************************************************************
 $table=MYSQL_QUERY("
 SELECT
  date,
  ddi,
   ddi,
   sum(countCT) as countCT,
   sum(Aon) as Aon,
   (sum(Aon)/sum(countCT)*100) as percent
 FROM
  day
 WHERE
  ((ddi='075')or(ddi='088')or(ddi='091')or(ddi='092')or(ddi='093')or(ddi='094')or(ddi='095')or(ddi='096')or(ddi='097'))
  and ((date >= '$syear-$smonth-$sday') and (date <= '$fyear-$fmonth-$fday'))
 GROUP BY
  ddi
 ORDER BY
  date;");
 $num_rows = MYSQL_NUM_ROWS($table);

 $i=0;
 IF ($num_rows==0) PRINT"<H1>За заданный период времени записей не найдено!<H1>";
 ELSE
 {
  PRINT "<TABLE CLASS=\"border\" WIDTH=100%>\n<CAPTION>Статистика определения номеров по дням подробно за $title</CAPTION>\n<TBODY>\n";
  PRINT "<TR><TH>Телефон услуги</A></TH><TH>Всего звонков</A></TH><TH>Определено звонков</A></TH><TH>Процент определения</A></TH></TR>\n";
  WHILE ($i < $num_rows)
  {
   $field1=mysql_result($table, $i, "date");	// 'Дата'
   $field2=mysql_result($table, $i, "ddi");	// 'Телефон услуги'
   $field3=mysql_result($table, $i, "countCT");	// 'Всего звонков'
   $field4=mysql_result($table, $i, "Aon");	// 'Определено звонков'
   $field5=mysql_result($table, $i, "percent");	// 'Процент определения'
   PRINT "<TR><TD>$field2</TD><TD class=\"ra\">$field3</TD><TD class=\"ra\">$field4</TD><TD";
   IF ($field5<90) PRINT " BGCOLOR=\"orange\"";
   PRINT ">$field5%</TD></TR>\n";
   $i++;
  }
  $table=MYSQL_QUERY("
  SELECT
   '' as z,
   date,
   ddi,
   sum(countCT) as countCT,
   sum(Aon) as Aon,
   (sum(Aon)/sum(countCT)*100) as percent
  FROM
   day
  WHERE
   ((ddi='075')or(ddi='088')or(ddi='091')or(ddi='092')or(ddi='093')or(ddi='094')or(ddi='095')or(ddi='096')or(ddi='097'))
   and ((date >= '$syear-$smonth-$sday') and (date <= '$fyear-$fmonth-$fday'))
  GROUP BY
   z;");
  $field1=mysql_result($table, 0, "countCT");	// 'Всего звонков'
  $field2=mysql_result($table, 0, "Aon");	// 'Определено звонков'
  $field3=mysql_result($table, 0, "percent");	// 'Процент определения'
  PRINT "<TR><TH>Всего</TH><TH CLASS=\"ra\">$field1</TH><TH CLASS=\"ra\">$field2</TH><TH>$field3%</TH></TR>\n</TBODY>\n</TABLE>\n";
  // *****************************************************************************
 }

PRINT "</BODY>\n</HTML>\n";
?>
