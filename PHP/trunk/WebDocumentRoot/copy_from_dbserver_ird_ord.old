<?
$conn_id=ftp_connect("10.1.1.2");
$login_result=ftp_login($conn_id, "root", "kron");
if ((!$conn_id)||(!$login_result)) die("Не удалось установить соединение с FTP сервером $ftp_server под именем $ftp_user_name!\r\n"); else print "Успешно установлено соединение с FTP сервером DBSERVER.\r\n";
// расчёт прошлого дня
$ldd=date("d",mktime(0,0,0,date("m"),date("d"),date("Y"))-((mktime(0,0,0,1,2,2000)-mktime(0,0,0,1,1,2000)))); // определение числа вчерашней даты
$ldm=date("m",mktime(0,0,0,date("m"),date("d"),date("Y"))-((mktime(0,0,0,1,2,2000)-mktime(0,0,0,1,1,2000)))); // определение месяца вчерашней даты
$ldy=date("Y",mktime(0,0,0,date("m"),date("d"),date("Y"))-((mktime(0,0,0,1,2,2000)-mktime(0,0,0,1,1,2000)))); // определение года вчерашней даты
//  копирование файлов таблицы ird_ за прошедший день с DBSERVER-а на FILESERVER
//if (ftp_chdir($conn_id, "shared_disk/usr/local/var//statistika/")) print "Выполнен переход в директорию '" . ftp_pwd($conn_id) . "'.\r\n"; else print "Не удалось сменить директорию!\r\n";
if (ftp_chdir($conn_id, "shared_disk/usr/mysql32356/data//statistika/")) print "Выполнен переход в директорию '" . ftp_pwd($conn_id) . "'.\r\n"; else print "Не удалось сменить директорию!\r\n";
if (ftp_get($conn_id, "D:\\mysql\\data\\ird\\oldformat_ird_$ldy$ldm$ldd.frm", "ird_$ldy$ldm$ldd.frm", FTP_BINARY)) print "Файл 'ird_$ldy$ldm$ldd.frm' успешно скопирован в файл 'oldformat_ird_$ldy$ldm$ldd.frm'.\r\n"; else die("Не удалось скопировать файл 'ird_$ldy$ldm$ldd.frm' в файл 'oldformat_ird_$ldy$ldm$ldd.frm'.\r\n");
if (ftp_get($conn_id, "D:\\mysql\\data\\ird\\oldformat_ird_$ldy$ldm$ldd.ISD", "ird_$ldy$ldm$ldd.ISD", FTP_BINARY)) print "Файл 'ird_$ldy$ldm$ldd.ISD' успешно скопирован в файл 'oldformat_ird_$ldy$ldm$ldd.ISD'.\r\n"; else die("Не удалось скопировать файл 'ird_$ldy$ldm$ldd.ISD' в файл 'oldformat_ird_$ldy$ldm$ldd.ISD'.\r\n");
if (ftp_get($conn_id, "D:\\mysql\\data\\ird\\oldformat_ird_$ldy$ldm$ldd.ISM", "ird_$ldy$ldm$ldd.ISM", FTP_BINARY)) print "Файл 'ird_$ldy$ldm$ldd.ISM' успешно скопирован в файл 'oldformat_ird_$ldy$ldm$ldd.ISM'.\r\n"; else die("Не удалось скопировать файл 'ird_$ldy$ldm$ldd.ISM' в файл 'oldformat_ird_$ldy$ldm$ldd.ISM'.\r\n");
if (ftp_get($conn_id, "D:\\mysql\\data\\ord\\oldformat_ord_$ldy$ldm$ldd.frm", "ord_$ldy$ldm$ldd.frm", FTP_BINARY)) print "Файл 'ord_$ldy$ldm$ldd.frm' успешно скопирован в файл 'oldformat_ord_$ldy$ldm$ldd.frm'.\r\n"; else die("Не удалось скопировать файл 'ord_$ldy$ldm$ldd.frm' в файл 'oldformat_ord_$ldy$ldm$ldd.frm'.\r\n");
if (ftp_get($conn_id, "D:\\mysql\\data\\ord\\oldformat_ord_$ldy$ldm$ldd.ISD", "ord_$ldy$ldm$ldd.ISD", FTP_BINARY)) print "Файл 'ord_$ldy$ldm$ldd.ISD' успешно скопирован в файл 'oldformat_ord_$ldy$ldm$ldd.ISD'.\r\n"; else die("Не удалось скопировать файл 'ord_$ldy$ldm$ldd.ISD' в файл 'oldformat_ord_$ldy$ldm$ldd.ISD'.\r\n");
if (ftp_get($conn_id, "D:\\mysql\\data\\ord\\oldformat_ord_$ldy$ldm$ldd.ISM", "ord_$ldy$ldm$ldd.ISM", FTP_BINARY)) print "Файл 'ord_$ldy$ldm$ldd.ISM' успешно скопирован в файл 'oldformat_ord_$ldy$ldm$ldd.ISM'.\r\n"; else die("Не удалось скопировать файл 'ord_$ldy$ldm$ldd.ISM' в файл 'oldformat_ord_$ldy$ldm$ldd.ISM'.\r\n");
ftp_quit($conn_id);
//  преобразование файлов в новый формат при помощи серии MySQL-запросов
$MYSQLCON=MYSQL_CONNECT("10.1.1.240","root","sqladmin") or die("Can't create connection");
//  преобразование файлов ird_ и ord_ за прошедший день
MYSQL_SELECT_DB("ird") or die("Не удалось установить подключение к БД ird на MySQL-сервере STATSERVER");
print "Установлено подключение к БД ird на MySQL-сервере STATSERVER.\r\n";
MYSQL_QUERY("DROP TABLE IF EXISTS ird.ird_$ldy$ldm$ldd;");
MYSQL_QUERY("CREATE TABLE ird.ird_$ldy$ldm$ldd (ani char(32) NOT NULL default '', ddi char(32) NOT NULL default '', datum date default NULL, vrijeme time default NULL, dur decimal(11,0) NOT NULL default '0', rc decimal(3,0) NOT NULL default '0', srv decimal(3,0) NOT NULL default '0', rm decimal(3,0) NOT NULL default '0', izg decimal(3,0) NOT NULL default '0', izgnum char(32) NOT NULL default '', druga_info decimal(3,0) NOT NULL default '0', v_oper char(8) default NULL, v_mreza char(8) default NULL, qid decimal(3,0) default NULL, ccid decimal(3,0) default NULL, d_qid decimal(3,0) default NULL, d_ccid decimal(3,0) default NULL, qdur decimal(11,0) NOT NULL default '0', KEY ani (ani(4)), KEY ddi (ddi(4))) TYPE=MyISAM PACK_KEYS=1;");
MYSQL_QUERY("INSERT INTO ird.ird_$ldy$ldm$ldd SELECT * FROM ird.oldformat_ird_$ldy$ldm$ldd;");
MYSQL_QUERY("DROP TABLE IF EXISTS ird.oldformat_ird_$ldy$ldm$ldd;");

MYSQL_SELECT_DB("ord") or die("Не удалось установить подключение к БД ord на MySQL-сервере STATSERVER");
MYSQL_QUERY("DROP TABLE IF EXISTS ord.ord_$ldy$ldm$ldd;");
MYSQL_QUERY("CREATE TABLE ord.ord_$ldy$ldm$ldd (ani char(32) NOT NULL default '', ddi char(32) NOT NULL default '', datum date default NULL, vrijeme time default NULL, dur decimal(11,0) NOT NULL default '0', rc decimal(3,0) NOT NULL default '0', srv decimal(3,0) NOT NULL default '0', rm decimal(3,0) NOT NULL default '0', izg decimal(3,0) NOT NULL default '0', izgnum char(32) NOT NULL default '', druga_info decimal(3,0) NOT NULL default '0', v_oper char(8) default NULL, v_mreza char(8) default NULL, qid decimal(3,0) default NULL, ccid decimal(3,0) default NULL, d_qid decimal(3,0) default NULL, d_ccid decimal(3,0) default NULL, qdur decimal(11,0) NOT NULL default '0', KEY ani (ani(4)), KEY ddi (ddi(4))) TYPE=MyISAM PACK_KEYS=1;");
MYSQL_QUERY("INSERT INTO ord.ord_$ldy$ldm$ldd SELECT * FROM ord.oldformat_ord_$ldy$ldm$ldd;");
MYSQL_QUERY("DROP TABLE IF EXISTS ord.oldformat_ord_$ldy$ldm$ldd;");

MYSQL_CLOSE($MYSQLCON);
print "Все операции выполнены.\r\n";
?>
